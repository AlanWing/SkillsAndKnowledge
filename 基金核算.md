

数据来源： 估值表（净值、持仓） 对账单、结算单（平仓盈亏、手续费、手续费返还、利息）

核算目的：确保估值表数据的可靠性

核算项：

+  交易盈亏差异（PNL差异） 
+  费用差异
+  税费差异
+  现金资产差异（期权）
+  市值差异（期权）

------

### 交易盈亏差异

交易盈亏差异 = 测算PNL - 估值表PNL

future:

**测算PNL** = 总平仓盈亏  + 手续费返还 - 手续费  + 持仓盯市盈亏 + 利息 - 出金 （全部来自于对账单、结算单） 

option:

**测算PNL** = (结算备付金 + 存出保证金 + 衍生工具 - 期货市值) - (结算备付金.shift(1) + 存出保证金.shift(1) + 衍生工具.shift(1) - 期货市值.shift(1)) + 手续费(对账单) + 手续费(结算单) - 出金

stock:

**测算PNL**= 测算-交易盈亏（quant平台计算）- 出金



**估值表PNL** = 估值表读出 + 赎回 - 申购 -出金

### 费用差异

费用差异 = 计算费用 - 估值表费用

估值表费用 = 估托管费 + 估服务费 + 估管理费 + 估业绩报酬 （All from valuation sheet.）

计算费用 = 计托管费 + 计服务费 + 计管理费 + 计业绩报酬 (Need to be calculated)



future:

```markdown
计-管理费 = 资产净值(前一日) * 管理费费率(当日)/ 365 * 相隔天数
计-托管费 = 资产净值(前一日) * 托管费费率(当日)/ 365 * 相隔天数
计-服务费 = 资产净值(前一日) * 服务费费率(当日)/ 365 * 相隔天数

相隔天数 = （当日日期-上一日日期）/ numpy.timedelta64(1,"D") 
管理费费率、托管费费率、服务费费率来自于Rates表
资产净值来源于
经典量化的托管费和服务费有2W打底

计业绩报酬：
if 若此基金在数据库中没有业绩报酬的费率: 业绩报酬为零
else:
	业绩报酬算法：
	1. 整体高水位：固定计提日+开放日+临时开放日（三种日期 业绩达到新高 就同一计提）
	2. 单人单笔高水位：固定计提日（扫描申购记录 如果达到计提条件 就计提）
	                +赎回确认日（在赎回开放日仅对赎回的记录进行计提 因此从申赎记录里获取赎回确认日）
	                
经典CTA-2较为特殊 
业绩报酬的基准日：
    20200514之前：
        固定开放日：每年6月30日和12月31日，如遇非工作日，则提前至最近一工作日。
        临时开放日
    20200514之后：
        固定时点：每季度最后一个交易日
        固定开放日：每年6月30日和12月31日，如遇非工作日，则提前至最近一工作日。
        临时开放日
CTA2的业绩报酬较特殊 按照20%计算
```

stock:

~~~markdown
管理费同上
托管费与服务费 英火9较特殊：
计算方法为两种算法求最大值
df12_['计-托管费1 = df12_['资产净值.shift(1) * df12_['托管费费率 / 365 * df12_['相隔天数
df12_['计-服务费1 = df12_['资产净值.shift(1) * df12_['服务费费率 / 365 * df12_['相隔天数
df12_['计-托管费2 = 10000 / 365 * df12_['相隔天数
df12_['计-服务费2 = 10000 / 365 * df12_['相隔天数

其他股票型基金同上

业绩报酬算法：
note为1 整体高水位
note为2、3、4 单人单笔
~~~



option:

~~~markdown
计-管理费 = 资产净值(前一日) * 管理费费率(当日)/ 365 * 相隔天数
计-托管费 = 资产净值(前一日) * 托管费费率(当日)/ 365 * 相隔天数
计-服务费 = 资产净值(前一日) * 服务费费率(当日)/ 365 * 相隔天数

根据基金ID获取业绩报酬计提日算法和业绩报酬率
根据基金ID获取业绩报酬计提日

业绩报酬算法：
note为1 整体高水位
note为2、3、4 单人单笔
~~~



### 税费差异



future:

```markdown
税费差异 = 计增值税+计附加税-估增值税-估附加税(估增值税、估附加税 from valuation)

计-增值税 = 有税的平仓盈亏 * 增值税费率 #有税平仓盈亏*增值税费率
计-附加税 = 计-增值税 * 附加税费率

有税的平仓盈亏 从settlement表获取
```

stock:

~~~markdown
计算税费 = 计增值税+计附加税+计暂估附加税+计暂估增值税

计-增值税 = (测算-交易盈亏 + 手续费 - %s_diff' % valuation_add_]) * 增值税费率 
计-附加税 = 计-增值税 * 附加税费率 #增值税*附加税费率
计-暂估增值税 = df12_34[valuation_add_] * 暂估增值税费率
计-暂估增值税 = 计-暂估增值税.apply(lambda x: max(x, 0))
计-暂估附加税 = 计-暂估增值税 * 暂估附加税费率

估值税费 = 估增值税+估附加税+估暂估附加税+估暂估增值税 (from valuation)
        
税费差异 = 计算税费-估值税费
~~~

option:

~~~markdown
计算税费 = 计增值税+计附加税+计暂估附加税+计暂估增值税

计-增值税 = (测算-交易盈亏 - (df12_3[valuation_add_] - df12_3[valuation_add_].shift(1)) - 期货平仓盈亏) * 增值税费率
交易盈亏差异 = 测算-交易盈亏 - 估-交易盈亏
计-附加税 = 计-增值税 * 附加税费率
计-暂估增值税 = df12_3[valuation_add_] * 暂估增值税费率
计-暂估增值税 = 计-暂估增值税.apply(lambda x: max(x, 0))
计-暂估附加税 = 计-暂估增值税 * 暂估附加税费率 


估值表税费 = 估-增值税 + 估-附加税 + 估-暂估增值税 + 估-暂估附加税

税费差异 = 计算税费 - 估值表税费
~~~

